---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: default
    server: https://kubernetes.default.svc
  project: default
  source:
    repoURL: https://nextcloud.github.io/helm
    targetRevision: 4.5.2
    chart: nextcloud
    helm:
      values: |
        ingress:
          enabled: true
          className: nginx
        nextcloud:
          host: nextcloud.localhost
          existingSecret:
            enabled: true
            secretName: nextcloud
            usernameKey: username
            passwordKey: password
            tokenKey: token
            #smtpUsernameKey: smtp-username
            #smtpPasswordKey: smtp-password
            #smtpHostKey: smtp-host
          configs:
            s3.config.php: |-
              <?php
              $CONFIG = array (
                'objectstore' => [
                        'class' => '\\OC\\Files\\ObjectStore\\S3',
                        'arguments' => [
                                'bucket' => getenv('BUCKET_NAME'),
                                'hostname' => getenv('BUCKET_HOST'),
                                'key' => getenv('BUCKET_ACCESS_KEY'),
                                'secret' => getenv('BUCKET_SECRET_KEY'),
                                'use_path_style' => true,
                        ],
                ],
              );
          extraEnv:
            - name: BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: nextcloud
                  key: bucket-name
            - name: BUCKET_HOST
              valueFrom:
                secretKeyRef:
                  name: nextcloud
                  key: bucket-host
            - name: BUCKET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: nextcloud
                  key: bucket-access-key
            - name: BUCKET_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: nextcloud
                  key: bucket-secret-key
          securityContext:
            runAsUser: 33
            runAsGroup: 33
            runAsNonRoot: true
            readOnlyRootFilesystem: false
          podSecurityContext:
            runAsUser: 33
            runAsGroup: 33
            runAsNonRoot: true
            readOnlyRootFilesystem: false
        livenessProbe:
          enabled: false
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        readinessProbe:
          enabled: false
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        startupProbe:
          enabled: false
          initialDelaySeconds: 120
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30
          successThreshold: 1
        internalDatabase:
          enabled: false
        externalDatabase:
          enabled: true
          type: mysql
          host: mariadb
          database: data-test
          existingSecret:
            enabled: true
            secretName: nextcloud
            usernameKey: db-username
            passwordKey: db-password
